<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://unpkg.com/cropperjs/dist/cropper.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/cropperjs"></script>
    <script type="module">
      async function checkUserAuthentication() {
        try {
          const response = await fetch(
            `http://${import.meta.env.VITE_BACKEND_URL}/user`,
            {
              method: "GET",
              credentials: "include",
            }
          );
          if (!response.ok) {
            window.location.href = `http://${
              import.meta.env.VITE_FRONTEND_URL
            }/`;
          } else {
            const data = await response.json();
            if (!data.user) {
              window.location.href = `http://${
                import.meta.env.VITE_FRONTEND_URL
              }/`;
            }
          }
        } catch (error) {
          window.location.href = `http://${import.meta.env.VITE_FRONTEND_URL}/`;
        }
      }
      checkUserAuthentication();
    </script>
    <style>
      .custom-btn {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .custom-btn.primary {
        background-color: #4caf50; /* Green */
        color: white;
      }

      .custom-btn.primary:hover {
        background-color: #347637;
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
      }

      .custom-btn.danger {
        background-color: #f44336; /* Red */
        color: white;
      }

      .custom-btn.danger:hover {
        background-color: #912120;
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
      }

      .custom-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: #f8f9fa;
        border-radius: 12px;
        padding: 10px 20px;
        font-size: 16px;
        color: #333;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .custom-select:hover {
        background-color: #e9ecef;
      }

      .custom-select:focus {
        outline: none;
        border-color: #0056b3;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      }

      .upload-section {
        background: #d2a0ff;
        transition: 0.2s ease;
      }

      .upload-section:hover {
        background: #e2bfff;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid px-4 px-md-5">
      <div
        class="position-absolute"
        style="
          width: 532px;
          height: 532px;
          right: 0vw;
          top: 30vh;
          background: radial-gradient(#d5d5ff 0%, #dd92e9 50%, #978ee2 100%);
          border-radius: 9999px;
          z-index: -1;
          filter: blur(200px);
          overflow: hidden;
        "
      ></div>

      <!-- header -->
      <nav class="navbar navbar-expand-lg navbar-light p-4">
        <div class="container-fluid justify-content-center">
          <a
            class="navbar-brand d-flex align-items-center"
            href="http://%VITE_FRONTEND_URL%"
          >
            <img
              src="/logocanvax.png"
              alt="Logo"
              class="img-fluid"
              style="width: 100px; transform: rotate(180deg)"
            />
            <h1
              class="text-dark fw-bold mx-2 d-none d-sm-block"
              style="font-size: 3rem"
            >
              &nbsp;CanvaX
            </h1>
          </a>
        </div>
      </nav>

      <!-- Judul Utama -->
      <div class="row align-items-center text-center my-5">
        <h2
          style="
            color: #37383c;
            font-size: 45px;
            font-weight: 700;
            text-transform: capitalize;
          "
        >
          Upload Your Image
        </h2>
      </div>

      <!-- Upload Section -->
      <div class="row justify-content-center my-5">
        <div class="col-md-6 col-12 px-3 px-md-5">
          <label class="w-100">
            <div
              class="p-4 col-12 rounded-pill"
              style="background: #a848ff"
              role="button"
            >
              <div class="p-4 rounded-pill upload-section">
                <div class="d-flex justify-content-center align-items-center">
                  <img
                    src="/up.png"
                    alt="Upload Icon"
                    style="width: 80px; height: 80px"
                  />
                </div>
                <div class="text-center mt-4">
                  <span style="color: #fffdfd; font-size: 15px"
                    >Drop file to upload or
                  </span>
                  <span
                    style="color: #2e3339; font-size: 15px; font-weight: bold"
                    >Browse</span
                  >
                </div>
              </div>
            </div>
            <input id="inputImage" class="d-none" type="file" name="file" />
          </label>
        </div>
      </div>

      <!-- Features Section -->
      <br /><br /><br />
      <div class="row text-center">
        <div class="col-md-4 col-12 mb-4">
          <img src="/recyle.png" alt="" style="width: 32px; height: 32px" />
          <h4 class="mt-3" style="font-weight: bold; color: #505258">
            Seamless Transformation
          </h4>
          <p style="color: #505258">
            Our advanced algorithm transforms your images into intricate batik
            patterns, preserving the unique essence of both traditional and
            modern designs.
          </p>
        </div>
        <div class="col-md-4 col-12 mb-4">
          <img src="/star.png" alt="" style="width: 41px; height: 41px" />
          <h4 class="mt-3" style="font-weight: bold; color: #505258">
            Fast and Easy
          </h4>
          <p style="color: #505258">
            No need for complex software. Simply upload your image, and our tool
            will generate a batik pattern in seconds, ready for download.
          </p>
        </div>
        <div class="col-md-4 col-12 mb-4">
          <img src="/coin.png" alt="" style="width: 38px; height: 38px" />
          <h4 class="mt-3" style="font-weight: bold; color: #505258">
            Free to Use
          </h4>
          <p style="color: #505258">
            Our tool is free to use with no hidden costs or watermarks. Download
            unlimited results for free.
          </p>
        </div>
      </div>
    </div>

    <div
      class="modal fade rounded"
      id="editorModal"
      tabindex="-1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      role="dialog"
      aria-hidden="true"
    >
      <div
        class="modal-dialog rounded modal-dialog-scrollable modal-dialog-centered modal-lg"
        role="document"
      >
        <div class="modal-content rounded px-4 pt-4">
          <div class="overflow-hidden rounded-5">
            <img id="image" class="w-100" />
          </div>
          <select
            id="paintingStyle"
            required
            class="form-select mt-3 custom-select"
          >
            <option value="MONET" selected>Monet</option>
            <option value="VANGOGH">Van Gogh</option>
            <option value="CAZENNE">Cazenne</option>
          </select>
          <div class="modal-footer d-flex justify-content-center gap-3">
            <button
              class="custom-btn danger"
              data-bs-dismiss="modal"
              aria-label="Close"
            >
              Cancel
            </button>
            <button id="cropButton" type="button" class="custom-btn primary">
              Transform
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="resultModal"
      tabindex="-1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
          <div
            class="modal-body d-flex justify-content-center align-items-center flex-column pb-4"
          >
            <img
              id="fetchedImage"
              src="/loading.svg"
              alt="Fetched Image"
              class="img-fluid mb-4"
            />
            <div id="loadingSpinner" class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <button
              id="completeButton"
              class="custom-btn primary"
              data-bs-dismiss="modal"
              style="display: none"
            >
              Complete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const inputImage = document.getElementById("inputImage");
      const image = document.getElementById("image");
      const cropButton = document.getElementById("cropButton");
      const editorModal = new bootstrap.Modal(
        document.getElementById("editorModal")
      );
      const resultModal = new bootstrap.Modal(
        document.getElementById("resultModal")
      );
      let cropper;
      let jobId;

      const loadingSpinner = document.getElementById("loadingSpinner");
      const fetchedImage = document.getElementById("fetchedImage");
      const completeButton = document.getElementById("completeButton");

      inputImage.addEventListener("change", function (event) {
        const file = event.target.files[0];

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            image.src = e.target.result;
            editorModal.show();
          };
          reader.readAsDataURL(file);
        }
      });

      document
        .getElementById("editorModal")
        .addEventListener("hidden.bs.modal", function () {
          cropper.destroy();
          image.src = "";
          inputImage.value = "";
        });

      document
        .getElementById("editorModal")
        .addEventListener("shown.bs.modal", function () {
          cropper = new Cropper(image, {
            dragMode: "move",
            viewMode: 3,
            autoCropArea: 0.8,
            responsive: true,
            restore: false,
            minContainerHeight: 400,
            aspectRatio: 1,
          });
        });

      cropButton.addEventListener("click", function (event) {
        event.preventDefault();
        if (cropper) {
          cropper.getCroppedCanvas().toBlob(function (blob) {
            const formData = new FormData();
            const paintingStyle =
              document.getElementById("paintingStyle").value;
            formData.append("file", blob, "input.jpg");
            formData.append("type", paintingStyle);
            fetch(`http://${import.meta.env.VITE_BACKEND_URL}/job`, {
              method: "POST",
              body: formData,
              credentials: "include",
            })
              .then((response) => {
                return response.json();
              })
              .then((data) => {
                jobId = data.jobId;
                editorModal.hide();
                resultModal.show();
              })
              .catch((error) => {
                Swal.fire({
                  title: "Error!",
                  text: "An error has occured, please try again",
                  icon: "error",
                  confirmButtonText: "OK",
                }).then(() => {
                  editorModal.hide();
                });
              });
          }, "image/jpeg");
        }
      });

      async function fetchImage() {
        loadingSpinner.style.display = "block";
        completeButton.style.display = "none";
        fetchedImage.src = "/loading.svg";

        try {
          const response = await fetch(
            `http://${import.meta.env.VITE_BACKEND_URL}/job/${jobId}`,
            {
              credentials: "include",
            }
          );

          if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            loadingSpinner.style.display = "none";
            completeButton.style.display = "block";
            fetchedImage.src = url;
            jobId = null;
          } else {
            const modal = document.getElementById("resultModal");
            if (modal.classList.contains("show")) {
              setTimeout(fetchImage, 1000);
            }
          }
        } catch (error) {
          const modal = document.getElementById("resultModal");
          if (modal.classList.contains("show")) {
            setTimeout(fetchImage, 1000);
          }
        }
      }

      document
        .getElementById("resultModal")
        .addEventListener("shown.bs.modal", () => {
          fetchImage();
        });

      document
        .getElementById("resultModal")
        .addEventListener("hidden.bs.modal", () => {
          loadingSpinner.style.display = "block";
          completeButton.style.display = "none";
          fetchedImage.src = "/loading.svg";
        });
    </script>
  </body>
</html>
